# 情報参謀報告書（Intelligence Report）
## game_route_search プロジェクト 第二期作戦準備評価

**報告日時**: 2026年1月29日  
**報告者**: 方面軍情報参謀（Claude Desktop）  
**宛先**: 参謀総長  
**機密区分**: 作戦準備文書

---

## 総括所見（Executive Summary）

現行コード資産は**第一期作戦（2D平面経路探索）**に最適化されており、第二期作戦（クオータービュー3D経路探索）への転用には**中規模のリファクタリング**が必要と評価する。ただし、師団長（Claude Code）の実装品質は高く、モジュール境界が明確なため、段階的拡張は十分に実現可能である。

| 評価項目 | 判定 | 備考 |
|----------|------|------|
| アーキテクチャ耐性 | ⚠️ 要拡張 | 重み・属性の動的化が必要 |
| 座標変換リスク | 🟢 低〜中 | `search.py` の改修で対応可能 |
| 情報不足 | 🔴 深刻 | 大本営からの技術パラメータ未定義 |

---

## 1. アーキテクチャの耐性評価

### 1.1 現行グラフモデルの構造

```python
# graph_builder.py 現行実装
DIRECTIONS = [(0, -1), (0, 1), (-1, 0), (1, 0)]  # 4近傍固定

graph.add_edge((x, y), (nx_coord, ny_coord), weight=1)  # 重み1固定
```

**診断結果**:

| 要素 | 現状 | 第二期要求 | Gap |
|------|------|-----------|-----|
| **エッジ重み** | `weight=1` 固定 | 高低差・斜め移動でコスト可変 | 🔴 要改修 |
| **移動方向** | 4近傍 | 8近傍（斜め移動追加） | 🟡 要拡張 |
| **ノード属性** | 座標 (x, y) のみ | 高度 z、地形タイプ等 | 🔴 要追加 |
| **ヒューリスティック** | 2Dマンハッタン | 3D距離 or 高低差補正 | 🔴 要改修 |

### 1.2 高低差対応の技術的課題

現行の `build_graph()` は**静的重み**を前提としており、以下の物理計算に対応できない：

```python
# 想定される第二期の重み計算（現行未実装）
def calculate_edge_weight(from_tile, to_tile):
    base_cost = 1.0
    
    # 斜め移動補正
    if is_diagonal_move(from_tile, to_tile):
        base_cost *= DIAGONAL_COST_FACTOR  # √2 ≈ 1.414 ?
    
    # 高低差補正
    height_diff = abs(to_tile.z - from_tile.z)
    if height_diff > 0:
        base_cost += height_diff * HEIGHT_COST_FACTOR  # 未定義
    
    return base_cost
```

**結論**: 現行アーキテクチャは「複雑な物理計算に耐えうる設計」**ではない**。ただし、`build_graph()` を**パラメタライズ**すれば拡張可能。

### 1.3 推奨改修方針

```python
# 拡張案: graph_builder.py
@dataclass
class TileData:
    x: int
    y: int
    z: int  # 高度追加
    terrain_type: str

def build_graph(
    game_map: GameMap,
    allow_diagonal: bool = False,
    height_cost_factor: float = 1.0,
    diagonal_cost_factor: float = 1.414,
) -> nx.Graph:
    # 動的重み計算ロジック
    ...
```

**改修規模見積**: 中（graph_builder.py 約50行追加、search.py ヒューリスティック改修）

---

## 2. 座標系の変換リスク評価

### 2.1 現行座標系の分析

```python
# map_loader.py
# 座標系: (x, y) where x=列, y=行
# 原点: 左上 (0, 0)
# y軸: 下方向が正

for y, row in enumerate(grid):
    for x, char in enumerate(row):
        # (x, y) = (列インデックス, 行インデックス)
```

**現行座標系**:
```
     x →
   0 1 2 3 4
y  S . . . #   y=0
↓  . # . # .   y=1
   . # . G .   y=2
```

### 2.2 等角投影法（Isometric）への変換

クオータービューでは、論理座標 (x, y, z) を画面座標 (screen_x, screen_y) に変換する：

```python
# 標準的な等角投影変換
TILE_WIDTH = 64
TILE_HEIGHT = 32

def logical_to_screen(x: int, y: int, z: int = 0) -> tuple[int, int]:
    screen_x = (x - y) * (TILE_WIDTH // 2)
    screen_y = (x + y) * (TILE_HEIGHT // 2) - z * TILE_HEIGHT
    return (screen_x, screen_y)
```

### 2.3 `search.py` への影響評価

> **訂正**: 依頼書では `finder.py` と記載されていたが、現行プロジェクトには該当ファイルは存在せず、探索ロジックは `search.py` に実装されている。

**影響箇所**:

| モジュール | 関数 | 影響度 | 理由 |
|------------|------|--------|------|
| `search.py` | `manhattan_distance()` | 🔴 高 | 2D専用、z軸未考慮 |
| `search.py` | `search_astar()` | 🟡 中 | ヒューリスティック差し替えで対応可 |
| `graph_builder.py` | `build_graph()` | 🔴 高 | 3D座標・可変重み未対応 |
| `map_loader.py` | `load_map()` | 🔴 高 | 高度情報読み込み未対応 |
| `visualize.py` | `render_path()` | 🟢 低 | CLI出力は2D維持可能 |

### 2.4 リファクタリング必要性の判定

**致命的リファクタリングは不要**と評価する。理由：

1. **モジュール分離が適切**: 座標変換は新規モジュール `coordinate_transform.py` として追加可能
2. **NetworkX の柔軟性**: ノード属性に z 座標を追加しても既存API互換
3. **段階的移行可能**: 2Dモードと3Dモードを引数で切り替える設計が可能

**ただし**、以下の改修は**必須**：

```python
# search.py 改修必須箇所
def manhattan_distance_3d(a: tuple[int, int, int], b: tuple[int, int, int]) -> float:
    """3D対応マンハッタン距離（または斜め考慮のチェビシェフ距離）"""
    dx = abs(a[0] - b[0])
    dy = abs(a[1] - b[1])
    dz = abs(a[2] - b[2])
    return dx + dy + dz * HEIGHT_WEIGHT  # HEIGHT_WEIGHT は要定義
```

---

## 3. 情報不足の特定（大本営への申請事項）

第二期作戦を完遂するために、大本営（NotebookLM）から以下の**具体的技術パラメータ**の提供を要請する：

### 3.1 移動コストの定義【最重要】

| パラメータ | 必要な定義 | 影響範囲 |
|------------|-----------|----------|
| `DIAGONAL_COST_FACTOR` | 斜め移動のコスト係数（√2? 1.5? 2?） | graph_builder, search |
| `HEIGHT_COST_FACTOR` | 高低差1単位あたりのコスト加算値 | graph_builder |
| `MAX_CLIMBABLE_HEIGHT` | 1ステップで登れる最大高低差 | graph_builder |
| `DESCENT_COST_RATIO` | 下りのコスト係数（登りと異なる場合） | graph_builder |

**質問例**:
> 「高度差2のタイルへの移動コストは、平地移動の何倍か？」
> 「斜め移動は許可されるか？許可される場合のコスト係数は？」

### 3.2 マップデータの規格【重要】

| パラメータ | 必要な定義 | 現行との差分 |
|------------|-----------|--------------|
| **ファイルフォーマット** | 高度情報の記述方法 | 現行: 2D文字グリッド |
| **高度の単位** | 整数? 浮動小数点? 範囲は? | 現行: なし |
| **地形タイプ** | 通行可/不可以外の属性（水、溶岩等） | 現行: `#`=壁、`.`=道のみ |
| **タイルサイズ** | Isometric描画用のピクセル寸法 | CLI専用なら不要 |

**想定フォーマット案**（大本営に確認要）:

```
# 案A: レイヤー分離型
--- height_layer ---
0 0 0 1 2
0 1 1 1 2
0 1 S 1 G
--- terrain_layer ---
. . . . #
. # . . .
. . . . .

# 案B: タプル型
(S,0) (.,0) (.,1) (.,2) (#,3)
(.,0) (#,1) (.,1) (.,2) (.,3)
(.,0) (.,1) (.,1) (.,1) (G,2)

# 案C: JSON型
{"tiles": [{"x": 0, "y": 0, "z": 0, "type": "S"}, ...]}
```

### 3.3 アルゴリズム要件【確認必要】

| 項目 | 質問 |
|------|------|
| **最短の定義** | コスト最小? ステップ数最小? |
| **A*ヒューリスティック** | 3D拡張時に許容される近似精度は? |
| **比較対象** | BFS は重み付きグラフに対応するか? → Dijkstra への変更? |

### 3.4 情報申請書テンプレート

```markdown
# 第二期作戦 技術パラメータ申請書

## 申請元: 方面軍情報参謀
## 申請先: 大本営（NotebookLM）

### 必須パラメータ（作戦遂行に不可欠）
1. 斜め移動コスト係数: ____
2. 高低差コスト係数: ____
3. 最大登攀高度: ____
4. マップファイルフォーマット仕様: ____

### 任意パラメータ（あれば精度向上）
5. 下り移動コスト係数: ____
6. 地形タイプ別コスト表: ____
7. Isometricタイル寸法: ____
```

---

## 4. 師団長（Claude Code）への評価

### 4.1 実装能力評価

| 評価項目 | 評点 | 根拠 |
|----------|------|------|
| **コード品質** | A | dataclass活用、型ヒント完備、例外設計適切 |
| **仕様準拠** | A+ | SPECIFICATION.md との乖離なし |
| **テスト網羅性** | A- | 正常系・異常系カバー、E2E不足 |
| **拡張性考慮** | B | 第二期要件は考慮外（仕様通り） |

### 4.2 第二期作戦における師団長への期待

師団長の実装能力は**十分に高い**。以下の条件が整えば、第二期作戦の遂行は可能と評価する：

1. **明確な仕様書の提供**: 大本営からの技術パラメータ
2. **段階的な作戦命令**: 2D→2.5D（高低差のみ）→3D（斜め移動）
3. **既存テストの維持**: 後方互換性テストの追加

---

## 5. 戦略的提言

### 5.1 第二期作戦の段階的アプローチ

```
Phase 2A: 高低差のみ対応（斜め移動なし）
├── map_loader.py: 高度読み込み追加
├── graph_builder.py: 重み計算の動的化
└── search.py: ヒューリスティック拡張

Phase 2B: 斜め移動対応
├── graph_builder.py: 8近傍対応
└── search.py: 斜めコスト対応ヒューリスティック

Phase 2C: Isometric座標変換（可視化向け）
└── coordinate_transform.py: 新規モジュール追加
```

### 5.2 リスク軽減策

1. **Feature Flag導入**: `--mode {2d,3d}` でモード切替
2. **後方互換性テスト**: 既存2Dマップが全て動作することを保証
3. **プロトタイプ先行**: 大本営からパラメータ取得後、最小実装で検証

---

## 6. 結論

> **第二期作戦は実行可能であるが、大本営からの技術パラメータ提供が前提条件となる。**

現行コード資産は拡張性の余地を残しており、師団長（Claude Code）の実装能力も十分である。作戦成功の鍵は、**移動コスト定義**と**マップフォーマット仕様**の早期確定にある。

**次の行動**:
1. 本報告書を参謀総長へ提出
2. 大本営（NotebookLM）への技術パラメータ申請
3. パラメータ確定後、Phase 2A 作戦命令書の策定

---

*以上、参謀総長殿へ具申す。*

**方面軍情報参謀**  
2026年1月29日
