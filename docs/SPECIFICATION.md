# ゲーム経路探索シミュレーター 仕様書（AGSP準拠）

## 目的・範囲
- クオータービューRPG等の移動ロジック検証用に、テキスト定義グリッドから最短経路を探索・可視化するCLIツールの仕様を定義する。
- 単一の真実は docs/SPECIFICATION.md とし、実装は本仕様に従う。コードの作成・インストールは本仕様策定段階では禁止。

## 環境（Environment Mandate）
- Python: 3.10 以上。グローバル環境は使用不可。
- 仮想環境: venv または conda を必須化。
- 依存: NetworkX ~= 3.6（バージョン固定を推奨）。依存は requirements.txt で明記。
- 参考例（仕様記述、実行禁止）:
```bash
# venv 作成・有効化（例）
python -m venv .venv
source .venv/bin/activate

# 依存インストール（例／実行禁止）
pip install "networkx~=3.6"
```

## 入出力仕様
- 入力（テキストマップ）:
  - 文字種: S=Start, G=Goal, #=Wall, .=Road
  - 形式: 行区切りの矩形グリッド（全行の幅が同一）。S と G は各1個必須。未知文字はエラー。
```text
S...#
.#.#.
.#.G.
```
- 出力（コンソール可視化）:
  - 経路上の Road('.') を '@' に置換して表示。
  - S と G は保持。Wall('#') は保持。
```text
@@@.#
.#@#.
.#@@.
```
- メトリクス表示（任意）:
  - 経路長（ノード数）、使用アルゴリズム名、比較モード時は両者のメトリクス（経路長・時間）を併記。

## グラフモデル
- ノード: 各セル座標 (x, y)。
- 隣接: 4近傍（上下左右）。対角移動は禁止。
- エッジ: 通行可能セル同士の無向エッジ、重み1。
- ヒューリスティック（A*）: マンハッタン距離 $|x_1-x_2| + |y_1-y_2|$。

## アルゴリズム要件（比較可能）
- A*（NetworkX の astar_path）:
  - ヒューリスティック: マンハッタン距離。
  - 通行不可セル（Wall）は探索対象外。
- 幅優先探索（BFS）:
  - 重みなし最短として networkx.shortest_path（または bfs_tree を用いた導出）。
- 計算量の目安:
  - BFS: $O(V + E)$
  - A*: ヒューリスティックに依存（最良時に探索削減、最悪は BFS 同等）。

## CLI 仕様
- コマンド形式（想定）:
```bash
game-route-search <map_file> [--algorithm {astar,bfs}] [--compare] [--metrics]
```
- 引数:
  - map_file: 必須。テキストマップへのパス。
  - --algorithm: 省略時は astar。
  - --compare: A* と BFS を両方実行し比較表示。
  - --metrics: 経路長や実行時間等のメトリクス表示。
- 終了コード:
  - 正常: 0
  - 入力不正・経路なし等: 非0。

## 機能要件
1. マップ読み込み・検証
   - 矩形性、文字種、S/G の存在チェック。未知文字は明示的エラー。
2. グラフ生成
   - 4近傍、通行不可除外、無向重み1のグラフ。
3. 経路探索
   - 指定アルゴリズムで S→G の最短経路を算出。到達不能時は「No path」相当のエラー。
4. 可視化
   - 経路を '@' で上書きして表示。S/G と Wall は保持。
5. 比較検証
   - A* と BFS の結果（経路長・時間）を並列表示。差異は明示。

## 非機能要件
- 再現性: 依存バージョン固定、仮想環境必須。
- パフォーマンス: 中規模グリッド（例: 200x200）で実用的応答時間。
- 可読性: エラーメッセージは簡潔で明確。

## エラー処理
- マップ不正（非矩形、未知文字、S/G 欠如・重複）: エラーメッセージ表示後、非0終了。
- 経路なし: 明示メッセージ表示、非0終了。

## ディレクトリ構成（計画）
- docs/: RULES, SPECIFICATION（単一の真実）
- src/: 実装予定（本仕様でモジュール境界のみ記述）
  - map_loader: 読み込み・検証
  - graph_builder: グラフ生成
  - search: A*/BFS 実行
  - visualize: 可視化
  - cli: 引数解析・実行フロー
- tests/: ユニット・統合テスト計画
- data/: サンプルマップ配置

## テスト計画（仕様）
- 正常系: 単純通路、複雑迷路、狭路。A* と BFS で同一経路長となる基本ケース確認。
- 異常系: 非矩形、未知文字、S/G 重複・欠如、到達不能。
- 比較: 同一マップで両アルゴリズムの経路長・時間を表示。

## 受け入れ条件
- 指定文字種・矩形判定・S/G 存在チェックが実装要件を満たす。
- A* と BFS の両実行が可能で、比較表示が行える。
- 出力が仕様通りに '@' で可視化される。
- venv/conda の使用が明記され、グローバル環境非依存。

## ガバナンス（AGSP準拠）
- Document Sovereignty: 仕様の単一の真実は docs/SPECIFICATION.md。コードや設定の変更前に本ドキュメントを更新・承認。
- NO IMPLEMENTATION/NO EXECUTION: 仕様策定段階では src/ へのコード追加・依存インストールは禁止。
- 変更管理: 仕様変更は docs への PR/レビューを経て承認後に実装着手。