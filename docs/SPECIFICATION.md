# ゲーム経路探索シミュレーター 仕様書（AGSP準拠・第二期改訂）

## 改訂要旨（Isometric Elevation）
- 座標変換レイヤーの独立設計を導入（論理グリッドと描画座標を分離）。
- 多重重み付け Dijkstra / 改良型 A* へ換装（地形・高低差・戦術優先度の統合コスト）。
- コスト定数はスプレッドシート由来 CSV を単一ソースとし、プログラム定数へ自動反映（生成）すること。

## 環境（Environment Mandate）
- Python: 3.10 以上。グローバル環境は使用不可。venv/conda を必須化。
- 依存: NetworkX ~= 3.6（固定を推奨）。依存は requirements.txt で明記。
- 実行例は記載のみ（本段階では実行禁止）。

## 入出力仕様 v2
- 入力（フェーズII形式・推奨）
  - Terrain Layer（例: data/terrain.txt）: 文字グリッド。地形コードは付録表に従う（例: '.'=平地, '~'=浅瀬, 'F'=森林, '^'=崖, 's'=砂地, '='=舗装路, '#'=不可）。
  - Elevation Layer（例: data/elevation.txt）: 整数グリッド（タイル高 $h[x,y]$）。
  - Start/Goal Layer（例: data/points.txt）: S/G の座標指定（または Terrain Layer へ重畳も可）。
  - Tactical Priority Layer（任意, data/priority.txt）: 非負実数のグリッド $P[x,y]$（高いほどペナルティ）。
  - すべて同一サイズの矩形グリッドであること。未知コードはエラー。
- 入力（フェーズI互換）
  - 単一テキストマップ（S,G,#,.）を受け付ける。Elevation=0、Terrain='.'（平地）、Priority=0 として解釈。
- 出力（コンソール可視化）
  - 経路セルを '@' で上書きし、S/G と壁 '#'+不可地形は保持。
  - メトリクス: 総コスト、経路長、アルゴリズム名、探索統計（展開ノード数/所要時間）。

## グラフモデル v2
- ノード: 論理グリッド座標 $(x,y)$。
- 近傍: 既定は4近傍（上下左右）。オプションで8近傍（対角）を許可。
- 辺: 高度差により非対称コストが生じ得るため有向辺（DiGraph）を推奨。
- 斜め移動を許可する場合、斜め移動補正係数を適用（地形依存）。

## 統合コスト関数（多重重み付け）
- 地形 $t = \mathrm{Terrain}(v)$ に対して、スプレッドシート由来の定数を用いる:
  - 基本移動コスト: $b_t$
  - 上昇追加コスト/段: $u_t$
  - 下降追加コスト/段: $d_t$
  - 斜め移動補正係数: $r_t$（8近傍時）
- 記号:
  - 高度差: $\Delta h = h(v) - h(u)$
  - 方向係数: $\kappa_{\mathrm{len}}(u,v;r_t) = 1$（軸）または $r_t$（斜め）
  - 戦術的優先度（ペナルティ）: $P(v) \ge 0$
  - 優先度重み: $\lambda \ge 0$（定数ファイルで与える）
- 単一ステップの移動コスト:
$$
c(u,v) \;=\; b_{t(v)} \cdot \kappa_{\mathrm{len}}(u,v; r_{t(v)})
\;+\; u_{t(v)} \cdot \max(0, \Delta h)
\;+\; d_{t(v)} \cdot \max(0, -\Delta h)
\;+\; \lambda \cdot P(v)
$$
- 経路総コストは各辺コストの総和。壁/不可地形（例: '#', 通行不可設定など）は遷移禁止。

## アルゴリズム換装
- Dijkstra（標準）: 上記コストを用いた最短路。非負重み必須を満たす。
- A*（改良）: 一貫ヒューリスティックを用いて高速化。
  - 推奨ヒューリスティック（許容的/一貫的）:
$$
\hat{h}(x) \;=\; d_{\mathrm{Manhattan}}(x, G) \cdot \min_{t} b_t
$$
  - 斜め許可時の下界近似（Octile 距離）:
$$
\hat{h}(x) \;=\; d_{\mathrm{octile}}(x,G) \cdot \min_{t} b_t,\quad
d_{\mathrm{octile}} \;=\; \bigl(\max(d_x,d_y) - \min(d_x,d_y)\bigr) + \sqrt{2}\cdot \min(d_x,d_y)
$$
  - 高度・優先度項は下界推定が難しいためヒューリスティックには含めない（許容性維持のため）。
- BFS はフェーズIIではベースライン参考のみ（重み無視のため比較外）。

## 座標変換レイヤー（独立設計）
- 目的: 論理グリッド座標系 ⇄ アイソメトリック描画座標系の双方向変換を、探索ロジックから完全分離。
- インターフェース（数式仕様）
  - 論理→描画:
$$
(X, Y) \;=\; \mathrm{to\_iso}(x,y,h),\quad
X = \frac{t_w}{2}\,(x - y),\ \ Y = \frac{t_h}{2}\,(x + y) - \beta \cdot h(x,y)
$$
  - 描画→論理（逆写像は丸め規則を伴う）:
$$
(x,y) \;=\; \mathrm{to\_grid}(X,Y,\hat{h})
$$
  - ここで $t_w, t_h$ はタイル寸法、$\beta$ は高度の垂直スケール。逆変換は許容誤差内での可逆性を保証。
- 境界条件/非機能
  - 依存禁止: search/graph/NetworkX への依存を禁ずる（純粋変換）。
  - 契約: iso→grid→iso の往復で画素単位の誤差境界（例: $\le 0.5$ px）を満たす。
  - テスト: ランダムサンプリングで往復誤差と単調性を検証。

## コスト定数の取り込み（スプレッドシート→プログラム定数）
- カノニカルソース: docs/strategy/02_TERRAIN_COST_MATRIX.md と同一内容の CSV（例: docs/strategy/terrain_costs.csv）。
  - 列: 地形コード, 基本 $b_t$, 上昇 $u_t$, 下降 $d_t$, 斜め $r_t$, 備考
- 生成規約（実装指示、実行禁止）
  - ビルド時（または pre-commit）に CSV からプログラム定数モジュールを自動生成（例: src/constants/terrain_costs.py もしくは JSON/YAML）。
  - アルゴリズム内へのリテラル埋め込みを禁止。必ず生成物から参照。
  - 初期係数（CSV 初期値の例）:
    - 平地: $b=1.0,\ u=2.0,\ d=0.5,\ r=1.414$
    - 浅瀬: $b=3.0,\ u=1.0,\ d=1.0,\ r=1.414$
    - 森林: $b=2.0,\ u=1.5,\ d=1.0,\ r=1.414$
    - 崖:   $b=5.0,\ u=10.0,\ d=2.0,\ r=1.414$
    - 砂地: $b=2.5,\ u=2.0,\ d=1.5,\ r=1.414$
    - 舗装: $b=0.8,\ u=1.5,\ d=0.4,\ r=1.414$
- 互換性: CSV が存在しない場合は平地既定（$b=1,\ u=0,\ d=0,\ r=\sqrt{2},\ P=0,\ h=0$）でフェーズI互換動作。

## CLI 仕様（改訂）
```bash
game-route-search <map_or_bundle> \
  --algo {dijkstra,astar} \
  [--allow-diagonal] \
  [--costs path/to/terrain_costs.csv] \
  [--priority path/to/priority.txt] \
  [--compare] [--metrics]
```
- --algo: 既定 dijkstra（多重重み付け）。astar は上記ヒューリスティックを使用。
- --allow-diagonal: 8近傍を許可し、斜め補正 $r_t$ を適用。
- --compare: dijkstra と astar を同一条件で比較出力（総コスト・展開数・時間）。
- 入出力バンドル: terrain/elevation/points(/priority) の複数ファイルを自動解決可能にする。

## 機能要件（更新）
1. マップ層の検証（矩形・コード集合・S/G 存在、一貫サイズ）
2. グラフ生成（DiGraph、近傍選択、遷移禁止の適用）
3. コスト集約（上記 $c(u,v)$ 式）
4. 経路探索（Dijkstra/A*）
5. 可視化（'@' 上書き・メトリクス表示）
6. 比較検証（同一条件での統計併記）

## 非機能要件
- 再現性: 依存固定、CSV→定数の生成物をバージョン管理。
- 性能目標: $200\times200$ で実用応答（平均 $|\Delta h|\le 2$ 前提）。A* は Dijkstra 比で展開ノード数を削減。
- 可観測性: 探索統計（展開ノード/到達距離/カット率）を出力可能。

## テスト計画（増補）
- コスト関数: 地形/高度/斜め/優先度の各項の単体検証（境界値: $\Delta h \in \{-1,0,+1\}$）。
- ヒューリスティック: 許容性検証（$\hat{h} \le$ 真値）。A* と Dijkstra の総コスト一致。
- 斜め許可: Octile 距離と $r_t$ の整合、4/8近傍切替の回帰防止。
- 座標変換: to_iso↔to_grid の誤差境界、単調性、逆写像の不動点（丸め含む）。
- 回帰: フェーズI互換マップで従来経路と出力が不変。

## 受け入れ条件（抜粋）
- CSV 由来の定数生成物のみからコストを参照（ハードコード禁止）。
- Dijkstra/A* の総コスト一致（同コスト関数・許容ヒューリスティック）。
- 出力が仕様通り '@' 可視化、メトリクス併記。
- 座標変換レイヤーが search/graph に非依存であること。

## ガバナンス（AGSP準拠）
- Document Sovereignty: 仕様の単一の真実は docs/SPECIFICATION.md。コードや設定の変更前に本書を更新・承認。
- NO IMPLEMENTATION/NO EXECUTION: 本段階は文書策定のみ。実装・インストールは禁止。
- 変更管理: 生成規約・CSVスキーマ変更はレビュー必須。

### 付録: 地形コード例（推奨）
| コード | 地形 | $b_t$ | $u_t$ | $d_t$ | $r_t$ |
|---|---|---:|---:|---:|---:|
| . | 平地 | 1.0 | 2.0 | 0.5 | 1.414 |
| ~ | 浅瀬 | 3.0 | 1.0 | 1.0 | 1.414 |
| F | 森林 | 2.0 | 1.5 | 1.0 | 1.414 |
| ^ | 崖 | 5.0 | 10.0 | 2.0 | 1.414 |
| s | 砂地 | 2.5 | 2.0 | 1.5 | 1.414 |
| = | 舗装 | 0.8 | 1.5 | 0.4 | 1.414 |
| # | 不可 | — | — | — | — |

## 最終査察追補（Final Inspection 統合）

### 座標変換の防御要件（数学的堅牢性）
- 境界防御（不変条件）: 論理座標は $0 \le x < W,\ 0 \le y < H$ を満たすこと。違反時は `OutOfBoundsError`（仕様上のカスタム例外）を送出。
- 型安全性: 描画座標は最終段で整数化（最近接丸め）し、ピクセルズレを排除。$X:=\mathrm{round}(X),\ Y:=\mathrm{round}(Y)$ を `int` 化。
- ゼロ除算防止: 初期化時に $t_w>0,\ t_h>0,\ \beta \ge 0$ を検証し、違反時は設定エラー。
- 双方向変換と誤差境界:
$$
X = \frac{t_w}{2}(x-y),\quad Y = \frac{t_h}{2}(x+y) - \beta \cdot h(x,y)
$$
  逆写像 $\mathrm{to\_grid}(X,Y,\hat{h})$ の往復誤差は $\le 0.5\ \mathrm{px}$ を満たすこと。
- 菱形（Diamond）判定領域の数学的定義:
  タイル中心 $(X_c,Y_c)$ に対し正規化 $u=\frac{2}{t_w}(X-X_c),\ v=\frac{2}{t_h}(Y-Y_c)$ を用い、
  同一タイルクリック条件を $|u|+|v|\le 1$ とする。境界上は最近接丸め規則で安定化。

### コスト飽和防御（MAX_COST_CAP）
- 統合コスト式にキャップを導入:
$$
c(u,v)=b_{t(v)}\cdot\kappa(u,v;r_{t(v)})+u_{t(v)}\max(0,\Delta h)+d_{t(v)}\max(0,-\Delta h)+\lambda P(v)
$$
$$
\tilde{c}(u,v)=\min\bigl(c(u,v),\ C_{\max}\bigr),\quad C_{\max}=255
$$
- 推奨スケール: 平地基本コスト $b_{\text{plain}}=10$。不可地形は $c=\infty$（遷移禁止）。
- CLI 追補: `--max-cost-cap 255`（既定 255）を仕様化。

### 受入テスト（Definition of Done）
- AC-1: ジグザグ抑制（タイブレーク）
  同一総コストの経路で直線性を優先。副目的関数として方向変化数（turns）最小化、直線区間長最大化を採用。
- AC-2: 高所迂回妥当性
  `登りコスト > (平地移動コスト × 迂回歩数)` の場合のみ迂回選択となることを確認。
- AC-3: クリック座標逆変換精度
  菱形条件 $|u|+|v|\le 1$ を満たす場合のみ同タイル判定。コーナー付近でも隣接誤判定がないこと。

### 実装命令（師団長・Claude Code 向け）
- 本追補の全要件（`OutOfBoundsError`、整数丸め、菱形判定、`MAX_COST_CAP=255`、AC-1〜3）を `src` 実装へ完全反映せよ。コスト定数は CSV 生成物から参照し、ハードコードを禁ずる。
